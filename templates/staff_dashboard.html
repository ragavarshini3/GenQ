<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GenQ - Staff Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <h2 class="nav-logo">ðŸŽ“ GenQ</h2>
            <div class="nav-right">
                <span class="user-info">Welcome, {{ user }}! ðŸ‘‹</span>
                <a href="{{ url_for('logout') }}" class="logout-btn">Logout</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="dashboard-header">
            <h1>âœ¨ Generate Question Paper</h1>
            <p>Create AI-powered question papers quickly</p>
        </div>

        <div class="staff-content">
            <div class="form-section">
                <h2>Paper Details</h2>
                <form method="POST" action="{{ url_for('generate') }}" class="generate-form">
                    <div class="form-group">
                        <label>Department:</label>
                        <select name="department" id="department" required onchange="updateCourses()">
                            <option value="">-- Select Department --</option>
                            {% for dept_id, dept in departments.items() %}
                                <option value="{{ dept_id }}" {% if user_dept == dept_id %}selected{% endif %}>{{ dept.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Course/Subject:</label>
                        <select name="course" id="course" required>
                            <option value="">-- Select Course --</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Syllabus Topics:</label>
                        <div id="syllabus-display" style="background: rgba(0, 198, 255, 0.05); padding: 12px; border-radius: 8px; margin-top: 8px; color: #ccc; min-height: 60px;">
                            <em>Select a course to view syllabus</em>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Difficulty Level:</label>
                        <select name="difficulty" required>
                            <option value="Easy">Easy</option>
                            <option value="Medium">Medium</option>
                            <option value="Hard">Hard</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <h3>Exam Pattern</h3>
                    </div>

                    <div class="exam-pattern">
                        <div class="pattern-input">
                            <label>2 Mark Questions:</label>
                            <input type="number" name="two_marks" value="5" min="1" required>
                        </div>
                        <div class="pattern-input">
                            <label>5 Mark Questions:</label>
                            <input type="number" name="five_marks" value="5" min="1" required>
                        </div>
                        <div class="pattern-input">
                            <label>10 Mark Questions:</label>
                            <input type="number" name="ten_marks" value="2" min="1" required>
                        </div>
                    </div>

                    <button type="submit" class="generate-btn">ðŸš€ Generate Paper</button>
                </form>
            </div>

            {% if output %}
                <div class="output-section">
                    {% if success %}
                        <div class="success-banner">âœ… Paper generated and saved successfully! It is hidden from students until you publish it.</div>
                        <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                            <a href="{{ url_for('download_pdf', paper_id=paper_id) }}" class="download-btn">ðŸ“¥ Download PDF</a>
                            {% if not paper_published %}
                                <form method="POST" action="{{ url_for('publish_paper', paper_id=paper_id) }}" style="display: inline;">
                                    <button type="submit" class="generate-btn" style="margin-top: 0;">âœ… Publish to Students</button>
                                </form>
                            {% endif %}
                        </div>
                    {% endif %}
                    <h2>Generated Question Paper</h2>
                    <div class="output-box">
                        <pre>{{ output }}</pre>
                    </div>
                </div>
            {% endif %}
        </div>

        {% if staff_papers %}
            <div class="form-section" style="margin-top: 30px;">
                <h2>ðŸ“„ Your Department Papers</h2>
                <div class="papers-grid">
                    {% for paper in staff_papers %}
                        <div class="paper-card">
                            <div class="paper-card-header">
                                <h3>{{ paper.course }}</h3>
                                {% if paper.published is defined and paper.published == false %}
                                    <span class="difficulty-badge difficulty-hard">Draft</span>
                                {% else %}
                                    <span class="difficulty-badge difficulty-easy">Published</span>
                                {% endif %}
                            </div>
                            <div class="paper-card-body">
                                <p><strong>Date:</strong> {{ paper.date }}</p>
                                <p><strong>Difficulty:</strong> {{ paper.difficulty }}</p>
                            </div>
                            <div class="paper-card-footer">
                                <a href="{{ url_for('view_paper', paper_id=paper.id) }}" class="view-btn">View</a>
                                {% if paper.published is defined and paper.published == false %}
                                    <form method="POST" action="{{ url_for('publish_paper', paper_id=paper.id) }}" style="flex: 1;">
                                        <button type="submit" class="view-btn">Publish</button>
                                    </form>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endif %}
    </div>

    <script>
        const departmentCourses = JSON.parse('{{ departments | tojson | safe }}');

        function updateCourses() {
            const departmentSelect = document.getElementById('department');
            const courseSelect = document.getElementById('course');
            const syllabusDisplay = document.getElementById('syllabus-display');
            
            const selectedDept = departmentSelect.value;
            
            // Clear course options
            courseSelect.innerHTML = '<option value="">-- Select Course --</option>';
            syllabusDisplay.innerHTML = '<em>Select a course to view syllabus</em>';
            
            if (selectedDept && departmentCourses[selectedDept]) {
                const courses = departmentCourses[selectedDept].courses;
                for (const [courseName, syllabus] of Object.entries(courses)) {
                    const option = document.createElement('option');
                    option.value = courseName;
                    option.textContent = courseName;
                    option.dataset.syllabus = syllabus;
                    courseSelect.appendChild(option);
                }
                
                // Add change event to course select
                courseSelect.onchange = function() {
                    const selectedOption = courseSelect.options[courseSelect.selectedIndex];
                    if (selectedOption && selectedOption.dataset.syllabus) {
                        syllabusDisplay.innerHTML = selectedOption.dataset.syllabus;
                    } else {
                        syllabusDisplay.innerHTML = '<em>Select a course to view syllabus</em>';
                    }
                }
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateCourses();
        });
    </script>
</body>
</html>
